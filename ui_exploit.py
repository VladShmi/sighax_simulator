"""
ui_exploit.py 
Exploit SIGHAX
"""
from PyQt6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QLabel,
    QPushButton, QFrame, QSplitter, QTextEdit
)
from PyQt6.QtCore import Qt, QTimer
from styles import C, STEP_COLORS, tag_style
from ui_block_visualizer import BlockVisualizer, HIGHLIGHT_TO_SEG


def get_cursor_and_active(step: dict):
    highlights = step.get('highlight_bytes', {})
    if not highlights:
        return None, None
    types = list(highlights.values())
    seg = HIGHLIGHT_TO_SEG.get(types[0])
    return seg, seg


class ExploitWidget(QWidget):
    def __init__(self, engine, parent=None):
        super().__init__(parent)
        self.engine      = engine
        self._anim_speed = 1400
        self._steps      = []
        self._step_idx   = 0
        self._blk        = None
        self._forge_info = None
        self._evil_fw    = b'EVIL_FIRM Boot9Strap ARM9=[ATTACKER CODE] NAND-RW OTP-dump'
        self._timer      = QTimer()
        self._timer.timeout.connect(self._next_step)
        self._build()

    def _build(self):
        root = QVBoxLayout(self)
        root.setContentsMargins(14, 14, 14, 14)
        root.setSpacing(10)

        # â”€â”€ ExplicaciÃ³n del exploit en dos columnas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        vulns_row = QHBoxLayout()
        vulns_row.setSpacing(10)

        def vuln_card(num, color, title, body):
            f = QFrame()
            f.setStyleSheet(
                f"QFrame {{background:{C['bg3']};border:2px solid {color};"
                f"border-radius:8px;}}"
                f"QLabel {{background:transparent;border:none;}}"
            )
            l = QVBoxLayout(f)
            l.setContentsMargins(14, 10, 14, 10)
            l.setSpacing(4)
            h = QHBoxLayout()
            badge = QLabel(f"  VULNERABILIDAD {num}  ")
            badge.setStyleSheet(
                f"color:#000;background:{color};border-radius:4px;"
                f"font-size:10px;font-weight:bold;padding:2px 6px;"
            )
            h.addWidget(badge)
            h.addStretch()
            l.addLayout(h)
            t = QLabel(title)
            t.setStyleSheet(f"color:{color};font-size:13px;font-weight:bold;")
            l.addWidget(t)
            b = QLabel(body)
            b.setWordWrap(True)
            b.setStyleSheet(f"color:{C['text_dim']};font-size:11px;")
            l.addWidget(b)
            return f

        vulns_row.addWidget(vuln_card(
            1, C['purple'],
            "Padding opcional (byte[1] = 0x02)",
            "El bootROM acepta firmas SIN padding 0xFF.\n"
            "Esto facilita enormemente el brute-force de firmas:\n"
            "hay muchÃ­simas menos restricciones que cumplir."
        ))
        vulns_row.addWidget(vuln_card(
            2, '#FFD60A',
            "âš¡ Byte de longitud 0x0D â€” el truco real",
            "Este byte dice al parser cuÃ¡ntos bytes saltar.\n"
            "Si lo aumentamos, el puntero pasa de aterrizar\n"
            "en el inner block â†’ a aterrizar en correct_hash.\n"
            "El parser se confunde y compara el hash consigo mismo."
        ))
        root.addLayout(vulns_row)

        # â”€â”€ Visualizador â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        self._viz = BlockVisualizer()
        # Resaltar la vulnerabilidad 2 desde el inicio
        QTimer.singleShot(300, lambda: self._viz._bar.set_active('len_byte'))
        root.addWidget(self._viz)

        # â”€â”€ El momento clave explicado visualmente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        key_frame = QFrame()
        key_frame.setStyleSheet(
            f"QFrame {{background:{C['bg2']};border:1px solid {C['orange']};"
            f"border-radius:8px;}}"
            f"QLabel {{background:transparent;border:none;}}"
        )
        key_l = QHBoxLayout(key_frame)
        key_l.setContentsMargins(16, 10, 16, 10)
        key_l.setSpacing(0)

        def arrow_label(txt, color=C['text_dim'], bold=False):
            l = QLabel(txt)
            l.setAlignment(Qt.AlignmentFlag.AlignCenter)
            style = f"color:{color};font-size:11px;font-family:'Consolas',monospace;"
            if bold:
                style += "font-weight:bold;"
            l.setStyleSheet(style)
            return l

        key_l.addWidget(arrow_label("FIRMA FORJADA", C['red'], True))
        key_l.addWidget(arrow_label("  â†’  bootROM descifra  â†’  ", C['text_dim']))
        key_l.addWidget(arrow_label("[00][02][00][30][31][30][0F]...", '#FFD60A', True))
        key_l.addWidget(arrow_label("  â†’  parser lee 0x0F=15 bytes  â†’  ", C['text_dim']))
        key_l.addWidget(arrow_label("puntero en correct_hash", C['orange'], True))
        key_l.addWidget(arrow_label("  â†’  salta 32 bytes mÃ¡s  â†’  ", C['text_dim']))
        key_l.addWidget(arrow_label("FUERA DEL BLOQUE", C['red'], True))
        key_l.addWidget(arrow_label("  â†’  compara hash consigo mismo  â†’  ", C['text_dim']))
        key_l.addWidget(arrow_label("SIEMPRE âœ“", C['green'], True))

        root.addWidget(key_frame)

        # â”€â”€ Controles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        ctrl = QHBoxLayout()

        self._btn_run = QPushButton("â–¶  Ejecutar exploit en bootROM vulnerable")
        self._btn_run.setObjectName("btn_run_exploit")
        self._btn_run.setFixedHeight(44)
        self._btn_run.clicked.connect(self._do_run)
        ctrl.addWidget(self._btn_run, 2)

        self._btn_step = QPushButton("â­  Paso a paso")
        self._btn_step.setFixedHeight(44)
        self._btn_step.clicked.connect(self._do_step)
        ctrl.addWidget(self._btn_step)

        self._btn_reset = QPushButton("â†º  Reset")
        self._btn_reset.setObjectName("btn_reset")
        self._btn_reset.setFixedHeight(44)
        self._btn_reset.clicked.connect(self._do_reset)
        ctrl.addWidget(self._btn_reset)

        root.addLayout(ctrl)

        # â”€â”€ Banner final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        self._pwned = QLabel(
            "ðŸ’€  EXPLOIT EXITOSO  â€”  bootROM aceptÃ³ el FIRM malicioso\n"
            "ARM9 ejecuta cÃ³digo del atacante  Â·  ring-1  Â·  NAND R/W  Â·  OTP dump  Â·  AES keys"
        )
        self._pwned.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self._pwned.setStyleSheet(
            f"color:#FF3B3B;font-size:14px;font-weight:bold;"
            f"background:#2D0D0D;border:2px solid #FF3B3B;border-radius:8px;padding:14px;"
        )
        self._pwned.hide()
        root.addWidget(self._pwned)

        # â”€â”€ Estado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        self._status = QLabel(
            "El bloque forjado cambia 0x0D â†’ 0x0F (salta 15 bytes en vez de 13), "
            "moviendo el puntero al campo correct_hash."
        )
        self._status.setWordWrap(True)
        self._status.setStyleSheet(
            f"color:{C['orange']};font-size:11px;"
            f"background:{C['bg3']};border-top:1px solid {C['border']};padding:6px 12px;"
        )
        root.addWidget(self._status)

    def _load_steps(self):
        if self._blk is None:
            self._blk, self._forge_info = self.engine.forge_sighax(self._evil_fw)
        self._steps    = self.engine.bootrom_verify_vulnerable(
            self._blk, self._evil_fw, self._forge_info
        )
        self._step_idx = 0

    def _do_run(self):
        self._pwned.hide()
        self._load_steps()
        self._btn_run.setEnabled(False)
        self._btn_step.setEnabled(False)
        self._timer.start(self._anim_speed)

    def _do_step(self):
        self._pwned.hide()
        if not self._steps:
            self._load_steps()
        self._timer.stop()
        self._show_step(self._step_idx)
        self._step_idx += 1
        if self._step_idx >= len(self._steps):
            self._pwned.show()
            self._btn_run.setEnabled(True)
            self._btn_step.setEnabled(True)
            self._step_idx = 0

    def _next_step(self):
        if self._step_idx >= len(self._steps):
            self._timer.stop()
            self._pwned.show()
            self._btn_run.setEnabled(True)
            self._btn_step.setEnabled(True)
            return
        self._show_step(self._step_idx)
        self._step_idx += 1

    def _show_step(self, idx: int):
        if idx >= len(self._steps):
            return
        s   = self._steps[idx]
        tag = s.get('tag', 'INFO')
        cursor_seg, active_seg = get_cursor_and_active(s)

        vals_text = ''
        if 'vals' in s:
            vals_text = '\n'.join(f"  {k}: {v}" for k, v in list(s['vals'].items())[:5])

        self._viz.set_parser_state(
            step_num    = s['id'],
            title       = s['title'],
            description = vals_text,
            cursor_seg  = cursor_seg,
            active_seg  = active_seg,
            tag         = tag,
        )

        TAG_COLORS = {
            'INFO': C['text_dim'], 'VULN': C['orange'],
            'EXPLOIT': '#FFD080', 'BYPASS': C['purple'],
            'PWNED': '#FF3B3B',
        }
        clr = TAG_COLORS.get(tag, C['text_dim'])
        self._status.setStyleSheet(
            f"color:{clr};font-size:11px;"
            f"background:{C['bg3']};border-top:1px solid {C['border']};padding:6px 12px;"
        )
        self._status.setText(f"[{tag}]  {s['title']}")

    def _do_reset(self):
        self._timer.stop()
        self._steps    = []
        self._step_idx = 0
        self._pwned.hide()
        self._viz.reset()
        QTimer.singleShot(100, lambda: self._viz._bar.set_active('len_byte'))
        self._btn_run.setEnabled(True)
        self._btn_step.setEnabled(True)
        self._status.setStyleSheet(
            f"color:{C['orange']};font-size:11px;"
            f"background:{C['bg3']};border-top:1px solid {C['border']};padding:6px 12px;"
        )
        self._status.setText(
            "El bloque forjado cambia 0x0D â†’ 0x0F (salta 15 bytes en vez de 13), "
            "moviendo el puntero al campo correct_hash."
        )